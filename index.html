<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Daure Express | Sistema de Entregas</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;background:#0b1220;font-family:Arial;color:#fff}
.container{max-width:900px;margin:auto;padding:20px}
h2,h3{text-align:center}
.card{background:#121c2e;border-radius:12px;padding:20px;margin-bottom:20px}
input,button{width:100%;padding:12px;border-radius:8px;border:none;margin-top:8px}
input{background:#1c2940;color:#fff}
button{cursor:pointer;font-weight:bold}
.calc,.add{background:#ff8c00;color:#000}
.remove{background:#8b1e1e;color:#fff}
.whats{background:#2ecc71;color:#000}
#map{height:300px;border-radius:12px;margin-top:15px}
.resumo p{margin:6px 0}
.pix{background:#0f2a1c;border-radius:12px;padding:15px;text-align:center}
</style>
</head>

<body>
<div class="container">

<h2>ğŸšš Daure Express</h2>

<div class="card">
<input id="nome" placeholder="Nome do cliente">
</div>

<div class="card">
<h3>ğŸ“ Coletas</h3>
<div id="coletas"></div>
<button class="add" onclick="addColeta()">â• Adicionar coleta</button>
</div>

<div class="card">
<h3>ğŸ“¦ Entregas</h3>
<div id="entregas"></div>
<button class="add" onclick="addEntrega()">â• Adicionar entrega</button>
</div>

<button class="calc" onclick="calcular()">Calcular Corrida</button>

<div id="map"></div>

<div class="card resumo" id="resumo" style="display:none">
<h3>ğŸ“Š Resumo da Corrida</h3>
<p>ğŸ“ DistÃ¢ncia total: <span id="dist"></span> km</p>
<p>â± Tempo estimado: <span id="tempo"></span></p>
<p>ğŸ’° Valor total: R$ <span id="total"></span></p>
<button class="whats" onclick="enviarWhats()">Confirmar no WhatsApp</button>
</div>

<div class="pix">
<p>ğŸ’³ Pagamento Pix</p>
<p><b>danieldaure2024@gmail.com</b></p>
<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=danieldaure2024@gmail.com">
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let map=L.map('map',{
  dragging:false,
  scrollWheelZoom:false,
  doubleClickZoom:false,
  zoomControl:false
}).setView([-26.2455,-49.3783],7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let markers=[];
function limparMapa(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
}

function addColeta(){
  const d=document.createElement("div");
  d.innerHTML=`
    <input placeholder="Ex: Serra Alta, SÃ£o Bento do Sul - SC">
    <button class="remove" onclick="this.parentElement.remove()">Remover coleta</button>
  `;
  document.getElementById("coletas").appendChild(d);
}

function addEntrega(){
  const d=document.createElement("div");
  d.innerHTML=`
    <input placeholder="Ex: Centro, Rio Negrinho - SC">
    <button class="remove" onclick="this.parentElement.remove()">Remover entrega</button>
  `;
  document.getElementById("entregas").appendChild(d);
}

addColeta();
addEntrega();

async function geocode(endereco){
  const tentativas=[
    endereco,
    endereco.replace(/[0-9]/g,""),
    endereco.split(",")[0],
    endereco.split(",").slice(-2).join(","),
    "SÃ£o Bento do Sul, SC",
    "Rio Negrinho, SC"
  ];

  for(const t of tentativas){
    const r=await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(t)}`,
      {headers:{'User-Agent':'DaureExpress'}}
    );
    const j=await r.json();
    if(j[0]) return [+j[0].lat,+j[0].lon];
    await new Promise(r=>setTimeout(r,700));
  }
  throw new Error("EndereÃ§o nÃ£o encontrado");
}

function distancia(a,b){
  const R=6371;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLon=(b[1]-a[1])*Math.PI/180;
  return R*2*Math.atan2(
    Math.sqrt(Math.sin(dLat/2)**2+
    Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLon/2)**2),
    Math.sqrt(1-Math.sin(dLat/2)**2)
  );
}

function formatarTempo(min){
  return min<60?`${min} min`:`${Math.floor(min/60)}h ${min%60}min`;
}

async function calcular(){
  limparMapa();
  try{
    const pontos=[];
    const listaColetas=[...document.querySelectorAll("#coletas input")];
    const listaEntregas=[...document.querySelectorAll("#entregas input")];

    for(const c of listaColetas){
      const p=await geocode(c.value);
      pontos.push({coord:p,texto:c.value,tipo:"coleta"});
      markers.push(
        L.marker(p,{icon:L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/red-dot.png"})}).addTo(map)
      );
    }

    for(const e of listaEntregas){
      const p=await geocode(e.value);
      pontos.push({coord:p,texto:e.value,tipo:"entrega"});
      markers.push(
        L.marker(p,{icon:L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png"})}).addTo(map)
      );
    }

    map.fitBounds(pontos.map(p=>p.coord));

    let km=0;
    for(let i=0;i<pontos.length-1;i++){
      km+=distancia(pontos[i].coord,pontos[i+1].coord);
    }

    const valorKm=km>35?1.40:0.95;
    const total=Math.max(9,km*valorKm);
    const tempo=Math.round(km*3);

    document.getElementById("dist").innerText=km.toFixed(2);
    document.getElementById("tempo").innerText=formatarTempo(tempo);
    document.getElementById("total").innerText=total.toFixed(2);
    document.getElementById("resumo").style.display="block";

    window.dadosWhats={
      coletas:listaColetas.map(i=>i.value),
      entregas:listaEntregas.map(i=>i.value),
      km:km.toFixed(2),
      tempo:formatarTempo(tempo),
      total:total.toFixed(2)
    };

  }catch{
    alert("NÃ£o foi possÃ­vel localizar um dos endereÃ§os. Use bairro + cidade.");
  }
}

function enviarWhats(){
  const d=window.dadosWhats;
  let msg=
`ğŸšš *Daure Express*
Cliente: ${document.getElementById("nome").value}

ğŸ“ *Coletas:*
${d.coletas.map(c=>"â€¢ "+c).join("\n")}

ğŸ“¦ *Entregas:*
${d.entregas.map(e=>"â€¢ "+e).join("\n")}

ğŸ“ DistÃ¢ncia: ${d.km} km
â± Tempo: ${d.tempo}
ğŸ’° Valor: R$ ${d.total}

âš ï¸ *Envie o comprovante Pix do seu pedido de coleta/entrega.*`;

  window.open(`https://wa.me/5547992925584?text=${encodeURIComponent(msg)}`);
}
</script>

</body>
</html>
